name: Go Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  releases-matrix:
    name: Release Go Binary
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # build and publish in parallel: linux/386, linux/amd64, linux/arm64, windows/386, windows/amd64, darwin/amd64, darwin/arm64
        goos: [linux, windows, darwin]
        goarch: ["386", amd64, arm64]
        exclude:
          - goarch: "386"
            goos: darwin
        steps:
          - name: Checkout code
            uses: actions/checkout@v4

          - name: Build binaries and add to the release
            uses: wangyoucao577/go-release-action@v1
            with:
                github_token: ${{ secrets.GITHUB_TOKEN }}
                goos: ${{ matrix.goos }}
                goarch: ${{ matrix.goarch }}
                asset_name: ente-${{ github.ref_name }}-${{ matrix.goos }}-${{ matrix.goarch }}
                release_name: ${{ github.ref_name }}
                goversion: "1.20"
                project_path: "./cli"
                pre_command: export CGO_ENABLED=0
                build_flags: "-trimpath"
                ldflags: "-X main.AppVersion=${{ github.ref_name }} -s -w"
                md5sum: false
                sha256sum: true
